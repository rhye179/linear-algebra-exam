<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>線形代数2 - ランダムCBT試験</title>
    <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    
    <script src="config.js"></script>
    <script src="questions.js"></script>

    <style>
        body { font-family: "Helvetica Neue", Arial, sans-serif; background-color: #f2f2f2; margin: 0; padding: 0; color: #333; height: 100vh; display: flex; flex-direction: column; overflow-x: hidden;}
        
        /* --- 共通スタイル --- */
        .screen { display: none; width: 100%; height: 100%; box-sizing: border-box; }
        .active-screen { display: flex; flex-direction: column; }

        /* 開始画面 */
        #start-screen {
            justify-content: center; align-items: center; text-align: center;
            background: linear-gradient(135deg, #e0eafc 0%, #cfdef3 100%);
        }
        .start-card {
            background: white; padding: 40px; border-radius: 10px; box-shadow: 0 10px 25px rgba(0,0,0,0.1); max-width: 600px; width: 90%;
        }
        h1 { margin-bottom: 20px; color: #2c3e50; }
        .exam-info { text-align: left; margin-bottom: 30px; background: #f8f9fa; padding: 20px; border-radius: 5px; }
        .big-btn {
            padding: 15px 50px; font-size: 1.2em; background-color: #007bff; color: white;
            border: none; border-radius: 30px; cursor: pointer; transition: transform 0.2s, background 0.2s;
            box-shadow: 0 4px 6px rgba(0,123,255,0.3);
            margin: 10px;
        }
        .big-btn:hover { background-color: #0056b3; transform: translateY(-2px); }
        .debug-btn { background-color: #6c757d; font-size: 1em; padding: 10px 30px; }
        .debug-btn:hover { background-color: #5a6268; }

        /* ヘッダー */
        #exam-header {
            background-color: #343a40; color: #fff; padding: 0 20px;
            display: flex; justify-content: space-between; align-items: center;
            height: 60px; flex-shrink: 0; box-shadow: 0 2px 5px rgba(0,0,0,0.2); z-index: 100;
        }
        #question-nav-bar {
            display: flex; gap: 8px; overflow-x: auto; 
            max-width: 70%; padding: 5px 0;
            -ms-overflow-style: none; scrollbar-width: none;
        }
        #question-nav-bar::-webkit-scrollbar { display: none; }
        .q-nav-btn {
            width: 36px; height: 36px; border-radius: 50%; border: 2px solid #6c757d;
            background-color: transparent; color: #adb5bd; font-weight: bold; font-size: 0.9em;
            cursor: pointer; flex-shrink: 0; transition: all 0.2s;
            display: flex; justify-content: center; align-items: center;
        }
        .q-nav-btn:hover { border-color: #fff; color: #fff; }
        .q-nav-btn.active { background-color: #007bff; border-color: #007bff; color: white; transform: scale(1.1); }

        #timer-label { font-size: 0.8em; color: #adb5bd; text-align: right;}
        #timer-display { font-size: 1.2em; font-family: 'Courier New', monospace; font-weight: bold; color: #fff; display: block;}
        .timer-warning { color: #ff6b6b !important; animation: pulse 1s infinite; }
        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.5; } 100% { opacity: 1; } }

        /* 問題エリア */
        #exam-body {
            flex-grow: 1; overflow-y: auto; padding: 20px; max-width: 900px; margin: 0 auto; width: 100%;
        }
        .question-slide { display: none; animation: fadeIn 0.3s; }
        .question-slide.active-slide { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
        
        /* デバッグモード（リスト表示） */
        .debug-list-view .question-slide {
            display: block !important; border-bottom: 3px dashed #ccc; padding-bottom: 40px; margin-bottom: 40px;
        }
        .debug-label {
            background: #ffc107; color: #333; padding: 2px 8px; border-radius: 4px; font-weight: bold; font-size: 0.8em; margin-bottom: 5px; display: inline-block;
        }
        .debug-footer { text-align: center; padding: 40px; border-top: 2px solid #333; }

        .question-block { display: flex; margin-bottom: 20px; align-items: flex-start; }
        .info-panel { width: 120px; background-color: #fff; border: 1px solid #dee2e6; padding: 10px; border-radius: 4px; font-size: 0.85em; margin-right: 15px; flex-shrink: 0; }
        .q-number { font-weight: bold; font-size: 1.2em; color: #d9534f; margin-bottom: 5px; display: block;}
        .status { display: block; margin-bottom: 5px; }
        .grade-result { font-weight: bold; color: #007bff; display: none; margin-top: 5px;}
        .content-panel { flex-grow: 1; background-color: #e7f3f5; border: 1px solid #b8d0d5; padding: 20px; border-radius: 4px; min-height: 300px;}
        .question-text { margin-bottom: 20px; line-height: 1.8; font-size: 1.05em; }
        
        input[type="text"] { border: 1px solid #888; padding: 5px; margin: 0 4px; text-align: center; border-radius: 3px; font-size: 1em; }
        .input-mini { width: 30px; } .input-small { width: 50px; } .input-med { width: 80px; }
        .correct-bg { background-color: #d4edda !important; border-color: #28a745 !important; }
        .incorrect-bg { background-color: #f8d7da !important; border-color: #dc3545 !important; }
        .matrix-table { display: inline-table; vertical-align: middle; margin: 5px; }
        .matrix-table td { padding: 4px; }
        .answer-section { background-color: #fff; padding: 20px; border: 1px solid #ccc; margin-top: 15px; border-radius: 4px;}
        .long-text { width: 80%; text-align: left !important; }

        .vector-row { display: flex; align-items: center; margin-bottom: 20px; font-size: 1.1em; }
        .vector-bracket-container { display: inline-flex; align-items: stretch; margin: 0 10px; }
        .bracket-left { width: 10px; border: 2px solid #333; border-right: none; margin-right: 2px; }
        .bracket-right { width: 10px; border: 2px solid #333; border-left: none; margin-left: 2px; }
        .vector-inputs { display: flex; flex-direction: column; gap: 4px; padding: 2px 0; }
        .vector-inputs input { margin: 0; width: 40px; }

        /* フッター */
        #exam-footer {
            background-color: #fff; border-top: 1px solid #ddd; padding: 15px 20px;
            display: flex; justify-content: space-between; align-items: center;
            height: 70px; flex-shrink: 0;
        }
        .nav-btn { padding: 10px 30px; font-size: 1em; background-color: #6c757d; color: white; border: none; border-radius: 5px; cursor: pointer; }
        .nav-btn:hover { background-color: #5a6268; }
        .nav-btn:disabled { background-color: #e9ecef; color: #adb5bd; cursor: not-allowed; }
        .submit-btn { background-color: #28a745; display: none; }
        .submit-btn:hover { background-color: #218838; }

        /* 結果画面 */
        #result-screen { justify-content: center; align-items: center; text-align: center; background-color: #f8f9fa; }
        .result-card { background: white; padding: 50px; border-radius: 10px; box-shadow: 0 10px 25px rgba(0,0,0,0.1); width: 80%; max-width: 600px; }
        .score-display { font-size: 3em; font-weight: bold; color: #2c3e50; margin: 20px 0; }
        .review-btn { background-color: #17a2b8; padding: 12px 30px; color: white; border: none; border-radius: 5px; cursor: pointer; font-size: 1.1em;}

        /* --- 解説機能用スタイル --- */
        .explanation-btn {
            display: none; /* 通常モードではデフォルト非表示 */
            margin-top: 10px; width: 100%;
            background-color: #ff9800; color: white; border: none; padding: 8px;
            border-radius: 4px; cursor: pointer; font-weight: bold;
            font-size: 0.9em;
        }
        .explanation-btn:hover { background-color: #e68900; }
        
        /* モーダル */
        .modal-overlay {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.5); z-index: 1000;
            justify-content: center; align-items: center;
        }
        .modal-box {
            background: white; width: 90%; max-width: 900px; height: 90vh; /* 高さ指定を変更 */
            border-radius: 8px; box-shadow: 0 5px 15px rgba(0,0,0,0.3);
            display: flex; flex-direction: column; padding: 20px;
        }
        .modal-header { font-size: 1.2em; font-weight: bold; border-bottom: 1px solid #ddd; padding-bottom: 10px; margin-bottom: 10px; display: flex; justify-content: space-between; align-items: center;}
        .modal-body { 
            overflow-y: auto; 
            flex-grow: 1; 
            padding: 0; /* PDFを端まで表示するためパディングを0に */
            background-color: #525659; /* PDFビューアっぽい背景色 */
        }
        .modal-body iframe {
            width: 100%;
            height: 100%;
            display: block;
        }
        .modal-close-btn { background: #6c757d; color: white; border: none; padding: 5px 15px; border-radius: 4px; cursor: pointer;}
        .modal-close-btn:hover { background: #5a6268; }
    </style>
</head>
<body>
    <script>
        (function(){
            // config.jsから設定読み込み、なければデフォルト
            const PW = (typeof CONFIG !== 'undefined') ? CONFIG.PASSWORD : "password"; 
            const KEY = (typeof CONFIG !== 'undefined') ? CONFIG.SESSION_KEY : "auth_key";
            
            if (localStorage.getItem(KEY) !== PW) {
                let input = prompt("【線形代数2】パスワードを入力してください:");
                if (input === PW) {
                    localStorage.setItem(KEY, PW);
                } else {
                    alert("パスワードが違います。");
                    document.body.innerHTML = `
                        <div style='display:flex; justify-content:center; align-items:center; height:100vh; flex-direction:column; font-family:sans-serif; background:#f8d7da; color:#721c24;'>
                            <h1>アクセス権限がありません</h1>
                            <p>正しいパスワードが必要です。</p>
                            <button onclick='location.reload()' style='padding:10px 20px; cursor:pointer;'>再入力する</button>
                        </div>
                    `;
                    throw new Error("Authentication Failed"); 
                }
            }
        })();
    </script>

    <div id="start-screen" class="screen active-screen">
        <div class="start-card">
            <h1>線形代数2 ランダム期末試験</h1>
            <div class="exam-info">
                <p><strong>試験時間：</strong> <span id="info-time">75</span>分</p>
                <p><strong>問題数：</strong> <span id="info-count">8</span>問</p>
                <p><strong>注意事項：</strong></p>
                <ul>
                    <li>開始ボタンを押すと、各テーマごとにランダムに問題が選出されます。</li>
                    <li>試験終了後に解説を確認できます。</li>
                </ul>
            </div>
            <button class="big-btn" onclick="startExam()">試験を開始する</button>
            <br>
            <button class="big-btn debug-btn" onclick="startDebugMode()">デバッグモード (全ストック表示)</button>
        </div>
    </div>

    <div id="exam-screen" class="screen">
        <div id="exam-header">
            <div id="question-nav-bar"></div>
            <div id="timer-label">
                残り時間<br>
                <span id="timer-display">--:--</span>
            </div>
        </div>

        <div id="exam-body"></div>

        <div id="exam-footer">
            <button class="nav-btn" id="prev-btn" onclick="moveSlide(-1)">← 前へ</button>
            <div style="flex-grow:1"></div>
            <button class="nav-btn" id="next-btn" onclick="moveSlide(1)">次へ →</button>
            <button class="nav-btn submit-btn" id="submit-btn" onclick="finishExam()">採点して終了</button>
        </div>
    </div>

    <div id="result-screen" class="screen">
        <div class="result-card">
            <h1>採点結果</h1>
            <div class="score-display" id="total-score-display">-- / --</div>
            <p>お疲れ様でした。</p>
            <button class="review-btn" onclick="reviewAnswers()">回答を見直す・解説を見る</button>
        </div>
    </div>

    <div id="explanation-modal" class="modal-overlay" onclick="closeExplanation(event)">
        <div class="modal-box" onclick="event.stopPropagation()">
            <div class="modal-header">
                <span>解説</span>
                <button class="modal-close-btn" onclick="closeExplanation()">閉じる</button>
            </div>
            <div class="modal-body" id="explanation-content">
                </div>
        </div>
    </div>

<script>
    let currentExamData = []; 
    let currentSlideIndex = 0;
    let timerInterval = null;
    let totalSeconds = (typeof EXAM_SETTINGS !== 'undefined' ? EXAM_SETTINGS.TIME_LIMIT_MINUTES : 75) * 60; 
    
    if(typeof EXAM_SETTINGS !== 'undefined'){
        document.getElementById('info-time').innerText = EXAM_SETTINGS.TIME_LIMIT_MINUTES;
        document.getElementById('info-count').innerText = EXAM_SETTINGS.TOTAL_QUESTIONS;
    }

    // =======================================================
    // システムロジック
    // =======================================================

    function startExam() {
        document.getElementById('start-screen').classList.remove('active-screen');
        document.getElementById('start-screen').style.display = 'none';
        document.getElementById('exam-screen').classList.add('active-screen');

        generateExamQuestions();
        generateNavButtons();
        updateSlideVisibility();
        
        MathJax.typesetPromise();
        startTimer();
    }

    // ★デバッグモード関数を修正：解説ボタンを表示するように変更
    function startDebugMode() {
        document.getElementById('start-screen').classList.remove('active-screen');
        document.getElementById('start-screen').style.display = 'none';
        document.getElementById('exam-screen').classList.add('active-screen');

        document.getElementById('exam-footer').style.display = 'none';
        document.getElementById('timer-label').style.display = 'none';
        document.getElementById('question-nav-bar').innerHTML = "<b>デバッグモード: 全ストック表示</b>";

        const examBody = document.getElementById('exam-body');
        examBody.innerHTML = "";
        examBody.classList.add('debug-list-view'); 

        currentExamData = [];
        let displayCount = 0;
        
        if (typeof questionStock === 'undefined') {
            alert("エラー: 問題データ(questions.js)が見つかりません。");
            return;
        }

        Object.keys(questionStock).forEach((key) => {
            const variations = questionStock[key];
            variations.forEach((qData, vIndex) => {
                displayCount++;
                const slideDiv = document.createElement('div');
                slideDiv.className = 'question-slide'; 
                
                const suffix = `_d_${key}_${vIndex}`;
                let modifiedHtml = qData.html.replace(/id="([^"]+)"/g, 'id="$1' + suffix + '"');
                modifiedHtml = modifiedHtml.replace(/name="([^"]+)"/g, 'name="$1' + suffix + '"');

                let modifiedCorrect = JSON.parse(JSON.stringify(qData.correct)); 

                if (qData.gradingType === "text_match") {
                    const newCorrect = {};
                    Object.keys(modifiedCorrect).forEach(k => {
                        newCorrect[k + suffix] = modifiedCorrect[k];
                    });
                    modifiedCorrect = newCorrect;
                } else if (qData.gradingType === "hybrid") {
                    if (modifiedCorrect.text && modifiedCorrect.text.id) {
                        modifiedCorrect.text.id += suffix;
                    }
                    if (modifiedCorrect.checkbox && modifiedCorrect.checkbox.name) {
                        modifiedCorrect.checkbox.name += suffix;
                    }
                }

                currentExamData.push({
                    index: displayCount - 1,
                    id: key + suffix,
                    maxPoints: 10,
                    html: modifiedHtml,
                    correct: modifiedCorrect,
                    gradingType: qData.gradingType,
                    explanation: qData.explanation || "" 
                });

                // 解説ボタンを表示状態(display:block)で埋め込む
                slideDiv.innerHTML = `
                    <div class="debug-label">${key} - パターン${vIndex + 1}</div>
                    <div class="question-block">
                        <div class="info-panel">
                            <span class="q-number">No. ${displayCount}</span>
                            <span class="status">確認用</span>
                            <span class="grade-result" id="${key + suffix}-grade"></span>
                            <button class="explanation-btn" style="display:block; background-color:#6c757d; margin-top:5px;" onclick="openExplanation(${displayCount - 1})">解説確認</button>
                        </div>
                        <div class="content-panel">
                            <div class="question-text">
                                ${modifiedHtml}
                            </div>
                        </div>
                    </div>
                `;
                examBody.appendChild(slideDiv);
            });
        });

        const debugFooter = document.createElement('div');
        debugFooter.className = 'debug-footer';
        debugFooter.innerHTML = `<button class="big-btn" onclick="finishExam()">デバッグ採点実行</button>`;
        examBody.appendChild(debugFooter);

        MathJax.typesetPromise();
    }

    function generateExamQuestions() {
        if (typeof questionStock === 'undefined') {
            alert("エラー: 問題データ(questions.js)が見つかりません。");
            return;
        }

        const examBody = document.getElementById('exam-body');
        examBody.innerHTML = ""; 
        currentExamData = [];
        
        const count = (typeof EXAM_SETTINGS !== 'undefined') ? EXAM_SETTINGS.TOTAL_QUESTIONS : 8;

        for (let i = 1; i <= count; i++) {
            const qKey = `q${i}`;
            const variations = questionStock[qKey];
            if (!variations) continue;

            const randomIndex = Math.floor(Math.random() * variations.length);
            const selectedQuestion = variations[randomIndex];

            currentExamData.push({
                index: i - 1,
                id: qKey,
                maxPoints: (i === 5) ? 6.0 : (i >= 6 ? 8.0 : 5.0), 
                explanation: selectedQuestion.explanation || "",
                ...selectedQuestion
            });

            const slideDiv = document.createElement('div');
            slideDiv.className = 'question-slide';
            slideDiv.id = `${qKey}-slide`;

            slideDiv.innerHTML = `
                <div class="question-block">
                    <div class="info-panel">
                        <span class="q-number">問題 ${i}</span>
                        <span class="status">未回答</span>
                        <span class="points">配点 ${currentExamData[i-1].maxPoints.toFixed(2)}</span>
                        <span class="grade-result" id="${qKey}-grade"></span>
                        <button class="explanation-btn" id="${qKey}-explain-btn" onclick="openExplanation(${i-1})">解説を見る</button>
                    </div>
                    <div class="content-panel">
                        <div class="question-text">
                            ${selectedQuestion.html}
                        </div>
                    </div>
                </div>
            `;
            examBody.appendChild(slideDiv);
        }
    }

    function generateNavButtons() {
        const navContainer = document.getElementById('question-nav-bar');
        navContainer.innerHTML = ''; 
        currentExamData.forEach((q, index) => {
            const btn = document.createElement('button');
            btn.className = 'q-nav-btn';
            btn.innerText = index + 1;
            btn.onclick = () => jumpToSlide(index);
            btn.id = `nav-btn-${index}`;
            navContainer.appendChild(btn);
        });
    }

    function startTimer() {
        updateTimerDisplay(totalSeconds);
        timerInterval = setInterval(() => {
            totalSeconds--;
            updateTimerDisplay(totalSeconds);
            if (totalSeconds <= 0) {
                clearInterval(timerInterval);
                alert("試験時間が終了しました。自動的に採点します。");
                finishExam();
            }
        }, 1000);
    }

    function updateTimerDisplay(sec) {
        const m = Math.floor(sec / 60);
        const s = sec % 60;
        document.getElementById('timer-display').textContent = 
            `${String(m).padStart(2, '0')}:${String(s).padStart(2, '0')}`;
        if (sec < 300) document.getElementById('timer-display').classList.add('timer-warning');
    }

    function jumpToSlide(index) {
        if (index >= 0 && index < currentExamData.length) {
            currentSlideIndex = index;
            updateSlideVisibility();
        }
    }
    function moveSlide(dir) { jumpToSlide(currentSlideIndex + dir); }

    function updateSlideVisibility() {
        document.querySelectorAll('.question-slide').forEach(el => el.classList.remove('active-slide'));
        const currentId = `${currentExamData[currentSlideIndex].id}-slide`;
        document.getElementById(currentId).classList.add('active-slide');
        
        for (let i = 0; i < currentExamData.length; i++) {
            const btn = document.getElementById(`nav-btn-${i}`);
            if (i === currentSlideIndex) {
                btn.classList.add('active');
                btn.scrollIntoView({ behavior: 'smooth', block: 'nearest', inline: 'center' });
            } else {
                btn.classList.remove('active');
            }
        }

        const prevBtn = document.getElementById('prev-btn');
        const nextBtn = document.getElementById('next-btn');
        const submitBtn = document.getElementById('submit-btn');

        prevBtn.disabled = (currentSlideIndex === 0);
        if (currentSlideIndex === currentExamData.length - 1) {
            nextBtn.style.display = 'none';
            submitBtn.style.display = 'block';
        } else {
            nextBtn.style.display = 'block';
            submitBtn.style.display = 'none';
        }
        document.getElementById('exam-body').scrollTop = 0;
    }

    function checkTextMatch(id, correctVal) {
        const el = document.getElementById(id);
        if(!el) return 0; 
        const val = el.value.replace(/\s+/g, ''); 
        if (val === String(correctVal)) {
            el.classList.add("correct-bg");
            el.classList.remove("incorrect-bg");
            return 1;
        } else {
            el.classList.add("incorrect-bg");
            el.classList.remove("correct-bg");
            return 0;
        }
    }

    function finishExam() {
        if (timerInterval) clearInterval(timerInterval);
        
        let grandTotal = 0; 
        let maxTotal = 0;
        const isDebug = document.getElementById('exam-body').classList.contains('debug-list-view');

        currentExamData.forEach(question => {
            const max = question.maxPoints;
            let score = 0;
            const correctData = question.correct;

            if (question.gradingType === "checkbox") {
                const inputs = document.querySelectorAll(`input[name="${question.id}"]:checked`);
                const selected = Array.from(inputs).map(cb => cb.value);
                let hasWrong = selected.some(v => !correctData.includes(v));
                if (!hasWrong && selected.length > 0) {
                    score = max * (selected.length / correctData.length);
                }
            } else if (question.gradingType === "text_match") {
                const keys = Object.keys(correctData);
                let pts = 0;
                keys.forEach(key => {
                    pts += checkTextMatch(key, correctData[key]);
                });
                score = max * (pts / keys.length);
            } else if (question.gradingType === "hybrid") {
                const textScorePart = checkTextMatch(correctData.text.id, correctData.text.val);
                const textPoints = (max * 0.5) * textScorePart;

                const cbName = correctData.checkbox.name;
                const correctVals = correctData.checkbox.vals;
                const inputs = document.querySelectorAll(`input[name="${cbName}"]:checked`);
                const selected = Array.from(inputs).map(cb => cb.value);

                const sortedSelected = selected.sort().toString();
                const sortedCorrect = correctVals.sort().toString();
                
                let cbPoints = 0;
                if (sortedSelected === sortedCorrect) {
                    cbPoints = (max * 0.5); 
                }
                score = textPoints + cbPoints;
            }

            updateStatus(question.id, score, max);
            grandTotal += score;
            maxTotal += max;
        });

        if (isDebug) {
            alert(`デバッグ採点完了: ${grandTotal.toFixed(2)} / ${maxTotal.toFixed(2)} 点`);
            return; 
        }

        document.getElementById('exam-screen').classList.remove('active-screen');
        document.getElementById('exam-screen').style.display = 'none';
        document.getElementById('result-screen').classList.add('active-screen');
        document.getElementById('result-screen').style.display = 'flex';
        
        const display = document.getElementById("total-score-display");
        display.innerHTML = `${grandTotal.toFixed(2)} / ${maxTotal.toFixed(2)} 点`;
        display.style.color = (Math.abs(grandTotal - maxTotal) < 0.1) ? "#28a745" : "#d9534f";
    }

    function updateStatus(qId, score, max) {
        const gradeSpan = document.getElementById(`${qId}-grade`);
        if(gradeSpan) {
            gradeSpan.innerText = `得点: ${score.toFixed(2)} / ${max.toFixed(2)}`;
            gradeSpan.style.display = 'inline';
        }
        const statusSpan = document.querySelector(`#${qId}-slide .status`);
        if(statusSpan) statusSpan.innerText = "採点済";
    }

    function reviewAnswers() {
        document.getElementById('result-screen').classList.remove('active-screen');
        document.getElementById('result-screen').style.display = 'none';
        const examScreen = document.getElementById('exam-screen');
        examScreen.style.display = 'flex';
        examScreen.classList.add('active-screen');
        
        const inputs = document.querySelectorAll('input');
        inputs.forEach(input => input.disabled = true);
        
        document.getElementById('timer-label').innerHTML = "<span style='color:#ffc107'>採点結果確認モード</span>";
        document.getElementById('submit-btn').style.display = 'none';
        
        const explainBtns = document.querySelectorAll('.explanation-btn');
        explainBtns.forEach(btn => btn.style.display = 'block');

        if (!document.getElementById('exam-body').classList.contains('debug-list-view')) {
             jumpToSlide(0);
        }
    }

    function openExplanation(index) {
        const modal = document.getElementById('explanation-modal');
        const contentBox = document.getElementById('explanation-content');
        
        const explanation = currentExamData[index].explanation;
        if (!explanation || explanation.trim() === "") {
            contentBox.innerHTML = "<p>（解説は白紙です）</p>";
        } else {
            contentBox.innerHTML = explanation;
        }
        
        modal.style.display = 'flex';
        MathJax.typesetPromise([contentBox]);
    }

    function closeExplanation(event) {
        if (!event || event.target.id === 'explanation-modal' || event.target.classList.contains('modal-close-btn')) {
             document.getElementById('explanation-modal').style.display = 'none';
        }
    }
</script>
</body>
</html>
